<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator Status Gizi Real-time (WHO-LMS)</title>
    <!-- Memuat Tailwind CSS untuk styling modern dan responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Konfigurasi Tailwind untuk penyesuaian estetika
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#059669', // Emerald 600
                        'secondary': '#1f2937', // Gray 800
                        'warning': '#f59e0b', // Amber 500
                        'danger': '#ef4444', // Red 500
                        'success': '#10b981', // Green 500
                        'info': '#3b82f6', // Blue 500
                        'subtle': '#d1d5db', // Gray 300
                    }
                }
            }
        }
    </script>
    <style>
        /* Gaya kustom untuk memastikan tampilan responsif dan rapat */
        body {
            background-color: #f9fafb; /* Gray 50 */
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2dpbg-gray-50px rgba(0, 0, 0, 0.05);
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        .auto-calculated-field {
            background-color: #f3f4f6;
            color: #4b5563;
            font-weight: 600;
            padding: 0.5rem; /* p-2 */
        }
        /* Style .compact-input-group dihapus karena struktur HTML diubah ke flex inline */
        
        .table-container {
            overflow-x: auto; /* Memastikan tabel dapat digulir di layar kecil */
        }
        .profile-table th, .profile-table td {
            padding: 0.3rem 0.5rem; /* Padding sel sangat kecil */
            font-size: 0.7rem; /* Ukuran font kecil untuk data yang banyak */
            white-space: nowrap;
            vertical-align: middle;
        }
        .card-result {
            padding: 0.75rem; /* Padding kartu hasil dikurangi */
        }
        .card-result h4 {
            font-size: 0.875rem; /* Text-sm */
        }
        .radio-cell {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 4px;
        }
        .radio-cell input[type="radio"] {
            margin-left: 4px;
            cursor: pointer;
        }
        /* Style untuk akordion */
        .accordion-content-inner {
            padding: 0.75rem; /* p-3 */
            background-color: white;
            border-bottom: 1px solid #e5e7eb; /* border-gray-200 */
        }
        
        /* MODAL STYLES */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Gaya TTL Custom Masking */
        #dob {
            font-size:14px;
            padding: 6px; /* slightly less padding */
            text-align:center;
            letter-spacing:1px;
        }
    </style>
</head>
<body class="font-sans min-h-screen p-2 md:p-4 flex flex-col items-center">

    <div class="w-full max-w-6xl bg-white card rounded-lg md:rounded-2xl p-4 md:p-6 mt-4 md:mt-8">
        <h1 class="text-xl md:text-3xl font-extrabold text-secondary mb-2 text-center">
            Kalkulator Status Gizi Anak (WHO-LMS)
        </h1>
        <p class="text-center text-gray-500 text-sm md:text-base mb-6">
            Perhitungan Z-score Real-time: 0-19 Tahun
        </p>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 md:gap-6">
            
            <!-- KOLOM DATA ANAK & INPUT (KIRI) -->
            <div class="md:col-span-1 space-y-3 p-3 border border-subtle rounded-xl bg-gray-50">
                
                <!-- Nama Anak -->
                <div class="flex items-center justify-between">
                    <label for="child-name" class="text-sm font-medium text-gray-700 w-1/3">Nama Anak</label>
                    <input type="text" id="child-name" value="" oninput="calculateNutritionStatus()"
                           placeholder="Masukkan Nama Anak"
                           class="w-2/3 p-2 text-sm border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">
                </div>

                <!-- Tanggal Lahir (TTL) -->
                <div class="flex items-center justify-between">
                    <label for="dob" class="text-sm font-medium text-gray-700 w-1/3">TTL</label>
                    <!-- Menghapus oninput lama, karena kini dikendalikan oleh event listener -->
                    <input type="text" id="dob" value="HH/BB/TTTT" 
                           placeholder="HH/BB/TTTT"
                           maxlength="10"
                           class="w-2/3 p-2 text-sm border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">
                </div>
                
                <!-- Jenis Kelamin (JK) -->
                <div class="flex items-center justify-between">
                    <label for="sex" class="text-sm font-medium text-gray-700 w-1/3">JK</label>
                    <select id="sex" oninput="calculateNutritionStatus()" 
                            class="w-2/3 p-2 text-sm border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">
                        <option value="male">Laki-laki</option>
                        <option value="female">Perempuan</option>
                    </select>
                </div>

                <!-- Berat Badan (BB) -->
                <div class="flex items-center justify-between">
                    <label for="weight" class="text-sm font-medium text-gray-700 w-1/3">BB (kg)</label>
                    <input type="number" id="weight" value="" step="0.1" min="0" oninput="calculateNutritionStatus()" 
                           placeholder="Cth: 13.0 kg" 
                           class="w-2/3 p-2 text-sm border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">
                </div>

                <!-- Tinggi Badan (TB/PB) -->
                <div class="flex items-center justify-between">
                    <label for="height" class="text-sm font-medium text-gray-700 w-1/3">TB/PB (cm)</label>
                    <input type="number" id="height" value="" step="0.1" min="0" oninput="calculateNutritionStatus()" 
                           placeholder="Cth: 90.0 cm" 
                           class="w-2/3 p-2 text-sm border border-gray-300 rounded-lg focus:ring-primary focus:border-primary transition duration-150">
                </div>

                <!-- Usia Terhitung (Otomatis) - Dihapus dari tampilan, tetapi disimpan untuk logika peringatan -->
                <div id="age-display-container" class="hidden">
                    <div id="age-display"></div>
                </div>

                <!-- Aksi Simpan -->
                <button onclick="saveChildProfile()" class="w-full p-3 bg-primary text-white font-bold rounded-lg hover:bg-green-700 transition duration-150 text-sm">
                    Simpan Profil
                </button>
            </div>

            <!-- KOLOM HASIL & VISUALISASI (KANAN) -->
            <div class="md:col-span-3 space-y-4">
                
                <!-- START: PROFIL TERSIMPAN -->
                <div class="p-3 border border-subtle rounded-xl bg-gray-50">
                    <!-- H2 "Profil Tersimpan" dihilangkan -->
                    
                    <!-- Input Pencarian -->
                    <input type="text" id="profile-search" oninput="filterChildList()" 
                           placeholder="Cari berdasarkan nama..."
                           class="w-full p-2 mb-2 border border-gray-300 rounded-lg text-sm">

                    <!-- NEW RADIO BUTTON FILTER DAN COPY BUTTON -->
                    <div id="table-filter-index" class="flex flex-wrap gap-2 mb-3 p-2 bg-white rounded-lg border border-gray-200 items-center justify-between">
                        <div class="flex flex-wrap gap-2 items-center">
                            <label class="inline-flex items-center text-sm font-medium text-gray-700">Tampilkan Indeks:</label>
                            <label class="inline-flex items-center text-xs space-x-1">
                                <input type="radio" name="table_index_view" value="WFA" checked onchange="setTableIndex(this.value)" class="form-radio text-primary border-primary">
                                <span>BB/U</span>
                            </label>
                            <label class="inline-flex items-center text-xs space-x-1">
                                <input type="radio" name="table_index_view" value="HFA" onchange="setTableIndex(this.value)" class="form-radio text-primary border-primary">
                                <span>TB/U</span>
                            </label>
                            <label class="inline-flex items-center text-xs space-x-1">
                                <input type="radio" name="table_index_view" value="WFL" onchange="setTableIndex(this.value)" class="form-radio text-primary border-primary">
                                <span>BB/TB</span>
                            </label>
                            <label class="inline-flex items-center text-xs space-x-1">
                                <input type="radio" name="table_index_view" value="BFA" onchange="setTableIndex(this.value)" class="form-radio text-primary border-primary">
                                <span>IMT/U</span>
                            </label>
                        </div>
                        
                        <button onclick="copyFilteredDataToClipboard()" class="px-3 py-1 bg-info text-white rounded-lg text-xs font-semibold hover:bg-blue-600 transition duration-150 flex items-center space-x-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2v-2m-4-4l-4 4m0 0l-4-4m4 4V5"></path></svg>
                            <span>Copy Data (Excel)</span>
                        </button>
                    </div>
                    <!-- END NEW RADIO BUTTON FILTER DAN COPY BUTTON -->

                    <div id="child-list-container" class="table-container max-h-48 overflow-y-auto p-1 bg-white rounded-lg border">
                        <table class="w-full profile-table text-left border-collapse">
                            <thead>
                                <tr id="child-list-header" class="bg-gray-200 sticky top-0">
                                    <!-- Headers will be dynamically generated by JS -->
                                </tr>
                            </thead>
                            <tbody id="child-list">
                                <tr><td colspan="7" class="text-center text-gray-500">Memuat data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- END: PROFIL TERSIMPAN -->

                <!-- START: Ringkasan Klasifikasi (AKORDION 1) -->
                <div class="mt-6">
                    <button id="accordion-toggle-summary" onclick="toggleAccordion('accordion-content-summary', 'accordion-icon-summary')" class="w-full flex justify-between items-center p-3 bg-secondary text-white font-bold rounded-lg hover:bg-gray-700 transition duration-150 text-left">
                        <h2 class="text-lg md:text-xl font-bold">Ringkasan Klasifikasi</h2>
                        <svg id="accordion-icon-summary" class="w-5 h-5 transition-transform duration-300 transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <!-- Konten akordion yang dapat disembunyikan -->
                    <div id="accordion-content-summary" class="overflow-hidden transition-all duration-300 max-h-0 border border-t-0 rounded-b-lg">
                        <div id="results-grid" class="grid grid-cols-2 md:grid-cols-4 gap-3 accordion-content-inner">
                            <!-- Cards Hasil akan di-render di sini -->
                        </div>
                    </div>
                </div>
                <!-- END: Ringkasan Klasifikasi -->


                <!-- START: Hasil Z-score & Visualisasi (AKORDION 2) -->
                <div class="mt-6">
                    <button id="accordion-toggle-results" onclick="toggleAccordion('accordion-content-results', 'accordion-icon-results')" class="w-full flex justify-between items-center p-3 bg-secondary text-white font-bold rounded-lg hover:bg-gray-700 transition duration-150 text-left">
                        <h2 class="text-lg md:text-xl font-bold">Hasil Z-score & Visualisasi</h2>
                        <svg id="accordion-icon-results" class="w-5 h-5 transition-transform duration-300 transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="accordion-content-results" class="overflow-hidden transition-all duration-300 max-h-0 border border-t-0 rounded-b-lg">
                        <div class="accordion-content-inner space-y-4">
                            <!-- Area Pesan Kesalahan/Informasi (Dibiarkan di luar grid) -->
                            <div id="message-box" class="p-3 text-sm text-green-800 bg-green-100 border-l-4 border-success rounded-lg">
                                <!-- Pesan akan diisi di sini setelah perhitungan -->
                                Masukkan data antropometri anak (Nama, TTL, BB, TB/PB) untuk memulai perhitungan status gizi.
                            </div>

                            <!-- Pilihan Indeks untuk Visualisasi -->
                            <div class="flex flex-wrap items-center space-x-3 p-3 bg-gray-100 rounded-lg text-sm">
                                <label for="visualization-index" class="font-medium text-gray-700">Visualisasi Kurva:</label>
                                <select id="visualization-index" onchange="updateVisualization()" 
                                        class="p-1 border border-gray-300 rounded-lg text-sm bg-white">
                                    <option value="WFA">BB/U (WFA)</option>
                                    <option value="HFA">TB/U (HFA)</option>
                                    <option value="WFL">BB/TB (WFL)</option>
                                    <option value="BFA">IMT/U (BFA)</option>
                                </select>
                                <span id="zscore-label" class="font-bold text-primary ml-4"></span>
                            </div>

                            <!-- Canvas Visualisasi -->
                            <div class="w-full bg-white border border-gray-300 rounded-xl shadow-inner overflow-hidden">
                                <canvas id="zscore-canvas" width="600" height="300" class="w-full h-auto"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- END: Hasil Z-score & Visualisasi -->
            </div>

        </div>
        
    </div>
    
    <!-- MODAL KONFIRMASI HAPUS -->
    <div id="delete-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-lg font-bold text-danger mb-3">Konfirmasi Penghapusan Profil</h3>
            <p class="text-sm text-gray-700 mb-4">
                Anda yakin ingin menghapus profil <strong id="modal-child-name"></strong>? Tindakan ini tidak dapat dibatalkan.
            </p>
            <input type="text" id="modal-delete-confirmation-input" 
                   placeholder="Ketik 'HAPUS' (huruf kapital) untuk konfirmasi" 
                   class="mt-2 w-full p-2 border border-danger rounded-lg text-sm focus:ring-danger focus:border-danger">
            <div class="flex justify-end space-x-2 mt-4">
                <button onclick="hideDeleteModal()" class="px-4 py-2 text-sm font-semibold rounded-lg bg-gray-300 text-secondary hover:bg-gray-400 transition duration-150">Batal</button>
                <button onclick="confirmDeletion()" class="px-4 py-2 text-sm font-semibold rounded-lg bg-danger text-white hover:bg-red-700 transition duration-150">Konfirmasi Hapus</button>
            </div>
        </div>
    </div>
    <!-- END MODAL HAPUS -->

    <!-- MODAL VALIDASI BARU (TTL/Age Limit) -->
    <div id="validation-modal" class="modal-overlay hidden">
        <div class="modal-content border-t-4 border-danger">
            <h3 id="validation-modal-title" class="text-lg font-bold text-danger mb-3">Peringatan Validasi!</h3>
            <p id="validation-modal-message" class="text-sm text-gray-700 mb-4">
                <!-- Pesan akan diisi di sini -->
            </p>
            <div class="flex justify-end space-x-2 mt-4">
                <button onclick="hideValidationModal()" class="px-4 py-2 text-sm font-semibold rounded-lg bg-primary text-white hover:bg-green-700 transition duration-150">OK</button>
            </div>
        </div>
    </div>
    <!-- END MODAL VALIDASI -->

    <!-- Import Firebase Services (MUST BE type="module") -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, onSnapshot, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Global Variables for Firebase instances
        let db, auth;
        window.db = db; // Make global for use outside module
        window.auth = auth;
        window.userId = null;
        window.currentChildId = null;
        window.pendingDeletionId = null; // State baru untuk konfirmasi penghapusan
        window.allChildProfiles = []; // Cache for filtering
        
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        window.db = db; 
        window.auth = auth;
        
        /** Menampilkan modal konfirmasi hapus. */
        window.showDeleteModal = function(docId, name, event) {
            if (event) event.stopPropagation();
            window.pendingDeletionId = docId;
            document.getElementById('modal-child-name').textContent = name;
            document.getElementById('modal-delete-confirmation-input').value = '';
            document.getElementById('delete-modal').classList.remove('hidden');
        }

        /** Menyembunyikan modal konfirmasi hapus. */
        window.hideDeleteModal = function() {
            window.pendingDeletionId = null;
            document.getElementById('delete-modal').classList.add('hidden');
        }

        /** Menampilkan modal validasi TTL/Usia. */
        window.showValidationModal = function(title, message) {
            document.getElementById('validation-modal-title').textContent = title;
            document.getElementById('validation-modal-message').textContent = message;
            document.getElementById('validation-modal').classList.remove('hidden');
        }

        /** Menyembunyikan modal validasi. */
        window.hideValidationModal = function() {
            document.getElementById('validation-modal').classList.add('hidden');
        }
        
        /** Utility: Converts YYYY-MM-DD to DD/MM/YYYY */
        window.dateToDMY = (isoDate) => {
            if (!isoDate) return '';
            try {
                const [year, month, day] = isoDate.split('-');
                return `${day}/${month}/${year}`;
            } catch {
                return '';
            }
        }

        // --- FIREBASE UTILITY FUNCTIONS ---
        
        /** Mengambil nilai tanggal lahir dari input date tunggal (tipe text, format DD/MM/YYYY). */
        window.getDOBString = function() {
            const dobInput = document.getElementById('dob').value;
            // Menghapus garis miring default jika input masih MASK
            const cleanDobInput = dobInput.includes('_') ? '' : dobInput;
            
            if (!cleanDobInput || cleanDobInput === '//' || cleanDobInput === MASK_DEFAULT) return null;

            // Expecting DD/MM/YYYY format
            const parts = cleanDobInput.split('/');
            if (parts.length !== 3) return null;

            const [dayStr, monthStr, yearStr] = parts;
            const day = parseInt(dayStr, 10);
            const month = parseInt(monthStr, 10);
            const year = parseInt(yearStr, 10);

            // Basic numerical validation
            if (isNaN(day) || isNaN(month) || isNaN(year)) return null;
            
            // Periksa batasan sederhana (bulan 1-12, tahun 1900-2100)
            if (month < 1 || month > 12 || year < 1900 || year > 2100) return null;

            // Check date validity (using Date object behavior)
            const dateCheck = new Date(year, month - 1, day); // month is 0-indexed for JS Date constructor

            // Check if the parts match the constructed date (e.g., prevents 30/02/2024 from being valid)
            if (dateCheck.getFullYear() !== year || dateCheck.getMonth() !== month - 1 || dateCheck.getDate() !== day) {
                return null;
            }

            // Return in ISO format (YYYY-MM-DD) for consistency with new Date() and storage
            const paddedMonth = String(month).padStart(2, '0');
            const paddedDay = String(day).padStart(2, '0');
            
            return `${year}-${paddedMonth}-${paddedDay}`;
        }


        /** Mengambil data input dari form. */
        window.getFormData = function() {
            const name = document.getElementById('child-name').value;
            const dob = window.getDOBString(); // Menggunakan fungsi baru untuk parsing D/M/Y
            const sex = document.getElementById('sex').value;
            const weight = parseFloat(document.getElementById('weight').value);
            const height = parseFloat(document.getElementById('height').value);
            
            if (!dob) return { name, dob: null, sex, weight, height };
            
            return { name, dob, sex, weight, height };
        }

        /** Signs in the user and sets up the listener for child profiles. */
        window.setupFirebase = async function() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token.length > 0) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        // console.log("Firebase Auth Ready. User ID:", window.userId);
                        window.loadChildProfiles();
                    } else {
                        // console.log("No user signed in. Using anonymous ID.");
                        window.userId = 'anonymous'; // Fallback
                    }
                });
            } catch (e) {
                console.error("Firebase initialization or sign-in failed:", e);
                window.userId = 'error';
            }
        }
        
        /** Saves the current child profile data to Firestore. */
        window.saveChildProfile = async function() {
            // Reset konfirmasi hapus jika ada
            window.hideDeleteModal();
            window.hideValidationModal();

            if (!window.userId || window.userId === 'anonymous') {
                document.getElementById('message-box').innerHTML = '<span class="text-red-800">Gagal Simpan: Autentikasi belum siap. Coba lagi.</span>';
                document.getElementById('message-box').className = 'p-3 text-sm bg-red-100 border-l-4 border-danger rounded-lg';
                return;
            }

            // 1. Ambil data form
            const formData = window.getFormData();
            const { name, dob, weight, height } = formData;
            
            let errorMessage = '';

            // 2. Validasi input dasar
            // Ambil nilai dari DOM secara langsung untuk cek kekosongan
            const nameValue = document.getElementById('child-name').value.trim();
            const dobValue = document.getElementById('dob').value;
            const weightValue = document.getElementById('weight').value.trim();
            const heightValue = document.getElementById('height').value.trim();

            if (!nameValue) { errorMessage = 'Nama Anak harus diisi.'; }
            else if (dobValue === MASK || dobValue === MASK_DEFAULT || dobValue === '//' || !dob) { 
                // Jika TTL tidak terisi/valid, gunakan modal validasi (KASUS 1)
                window.showValidationModal('Tanggal Lahir Tidak Valid', 'Pastikan Tanggal Lahir diisi lengkap dengan format HH/BB/TTTT yang valid. Cek tanggal, bulan, dan tahun.');
                return;
            }
            else if (weightValue === '' || isNaN(weight) || weight <= 0) { errorMessage = 'Berat Badan (BB) harus diisi dengan nilai yang valid (> 0).'; }
            else if (heightValue === '' || isNaN(height) || height <= 0) { errorMessage = 'Tinggi/Panjang Badan (TB/PB) harus diisi dengan nilai yang valid (> 0).'; }
            
            if (errorMessage) {
                // Tampilkan pesan error umum untuk input non-TTL (KASUS 3)
                window.showMessage(`Gagal Simpan: ${errorMessage}`, 'danger');
                return;
            }

            // 3. Cek Batas Usia
            const ageResult = calculateAge(dob);
            const currentAgeMonths = ageResult ? ageResult.totalMonths : 0;
            const ageDisplayStatus = ageResult ? ageResult.display : 'Format Tgl Salah / Belum Lengkap';
            
            if (currentAgeMonths > MAX_AGE_MONTHS) {
                 // Usia di atas batas (KASUS 2)
                window.showValidationModal('Batas Usia Terlampaui', `Usia anak (${ageDisplayStatus}) melebihi batas maksimum WHO-LMS (19 tahun / ${MAX_AGE_MONTHS} bulan). Data tidak akan disimpan.`);
                return; 
            }
            
            // 4. Paksa perhitungan status gizi terbaru
            window.calculateNutritionStatus(); 

            // 5. Ambil hasil status gizi dari global state setelah perhitungan
            const lastStatus = window.currentZScoreResults; 
            
            // 6. Validasi hasil status gizi
            const validStatus = Object.values(lastStatus).some(res => res && res.zScore && res.zScore !== 'N/A');
            
            if (!validStatus) {
                window.showMessage('Gagal Simpan: Status gizi belum berhasil dihitung. Periksa kembali input Usia dan Tinggi/Panjang Badan.', 'danger');
                return;
            }

            const docId = window.currentChildId || Date.now().toString();
            
            // Tentukan primary index default (WFA) atau yang terakhir dipilih
            const primaryIndex = window.currentChildId 
                                ? window.allChildProfiles.find(p => p.id === window.currentChildId)?.primaryIndex || 'WFA'
                                : 'WFA';

            // Gabungkan data antropometri dan status gizi terbaru
            const childData = { 
                name: nameValue, // Gunakan nilai yang sudah di-trim
                dob: dob,
                sex: formData.sex,
                weight: weight,
                height: height,
                lastStatus: lastStatus, 
                primaryIndex: primaryIndex, // Simpan indeks utama
                savedAt: new Date() 
            };
            
            const docRef = doc(db, 'artifacts', appId, 'users', window.userId, 'children', docId);

            try {
                await setDoc(docRef, childData);
                window.currentChildId = null; // Reset ID agar entri berikutnya dianggap 'Profil Baru'
                
                // Reset message box to default state or clearance state
                window.showMessage('Profil anak berhasil disimpan!', 'success');

                // Setelah berhasil simpan, reset form untuk profil baru
                window.clearCurrentChild();

            } catch (e) {
                console.error("Error saving document: ", e);
                window.showMessage('Gagal Simpan ke Database. Lihat konsol untuk detail.', 'danger');
            }
        }
        
        /** Updates the primary index for a saved profile in Firestore. */
        window.updateProfilePrimaryIndex = async function(docId, index, event) {
            if (event) event.stopPropagation();
            window.hideDeleteModal();
            window.hideValidationModal();

            const docRef = doc(db, 'artifacts', appId, 'users', window.userId, 'children', docId);

            try {
                await updateDoc(docRef, { primaryIndex: index });
                // onSnapshot handles UI update
            } catch(e) {
                console.error("Failed to update primary index:", e);
                const statusCell = document.getElementById(`status_cell_${docId}`);
                if (statusCell) {
                    statusCell.textContent = 'Gagal Update';
                    statusCell.className = 'bg-danger-100 font-bold';
                }
            }
        }

        /** Memuat data anak yang dipilih ke form. */
        window.loadChildData = function(id, data) {
            window.hideDeleteModal();
            window.hideValidationModal();
            window.currentChildId = id;
            document.getElementById('child-name').value = data.name;

            // MENGUBAH INPUT DATE DARI ISO KE D/M/Y UNTUK TAMPILAN
            document.getElementById('dob').value = window.dateToDMY(data.dob); 

            document.getElementById('sex').value = data.sex;
            document.getElementById('weight').value = parseFloat(data.weight);
            document.getElementById('height').value = parseFloat(data.height);

            window.calculateNutritionStatus(); 

            window.showMessage('Profil ' + data.name + ' berhasil dimuat.', 'info');
        }
        
        /** Melakukan proses penghapusan setelah konfirmasi MODAL. */
        window.confirmDeletion = async function() {
            const docId = window.pendingDeletionId;
            if (!docId) return;

            const input = document.getElementById('modal-delete-confirmation-input').value;
            if (input !== 'HAPUS') {
                // Konfirmasi gagal
                document.getElementById('modal-delete-confirmation-input').classList.add('border-danger');
                document.getElementById('modal-delete-confirmation-input').placeholder = "Konfirmasi tidak valid. KETIK 'HAPUS'!";
                return;
            }
            
            window.hideDeleteModal(); // Sembunyikan modal sebelum operasi DB

            const docRef = doc(db, 'artifacts', appId, 'users', window.userId, 'children', docId);
            try {
                await deleteDoc(docRef);
                if (window.currentChildId === docId) {
                    window.clearCurrentChild();
                }
                window.showMessage('Profil berhasil dihapus.', 'success');
                
            } catch (e) {
                console.error("Error deleting document: ", e);
                window.showMessage('Gagal menghapus profil.', 'danger');
            } finally {
                 window.pendingDeletionId = null;
                 // Asumsi window.resetMessageBox ada, tapi jika tidak ada, biarkan setTimeout saja.
                 setTimeout(() => {
                     document.getElementById('message-box').innerHTML = 'Masukkan data antropometri anak (Nama, TTL, BB, TB/PB) untuk memulai perhitungan status gizi.';
                     document.getElementById('message-box').className = 'p-3 text-sm text-green-800 bg-green-100 border-l-4 border-success rounded-lg';
                 }, 3000);
            }
        }

        /**
         * Merender daftar anak ke dalam tabel, menerapkan filter dan menampilkan kolom berdasarkan
         * indeks yang dipilih melalui radio button.
         */
        window.renderChildList = function() {
            window.hideDeleteModal(); 
            window.hideValidationModal();
            const searchText = document.getElementById('profile-search').value.toLowerCase();
            const selectedIndex = window.currentTableIndex; // Ambil indeks terpilih
            
            const filteredProfiles = window.allChildProfiles.filter(profile => 
                profile.name.toLowerCase().includes(searchText)
            );
            
            const tbody = document.getElementById('child-list');
            const thead = document.getElementById('child-list-header');

            // 1. Definisikan Judul Indeks yang Dipilih
            const indexTitles = {
                'WFA': 'BB/U (Z-score)',
                'HFA': 'TB/U (Z-score)',
                'WFL': 'BB/TB (Z-score)',
                'BFA': 'IMT/U (Z-score)'
            };

            // 2. GENERATE HEADER HANYA DENGAN 7 KOLOM (Termasuk Umur)
            thead.innerHTML = `
                <th class="p-1">No</th>
                <th class="p-1">Nama</th>
                <th class="p-1">JK</th>
                <th class="p-1">Umur</th>
                <th class="p-1">${indexTitles[selectedIndex]}</th>
                <th class="p-1">Status</th>
                <th class="p-1">Aksi</th>
            `;
            
            tbody.innerHTML = '';
            
            if (filteredProfiles.length === 0) {
                // Pastikan colspan sesuai dengan jumlah kolom baru (7)
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 p-2">Tidak ada profil yang cocok atau belum tersimpan.</td></tr>';
                return;
            }
            
            // Map fungsi helper
            const getZScoreDisplay = (res) => res?.zScore !== undefined ? (res.zScore === 'N/A' ? 'N/A' : res.zScore.toFixed(2)) : 'N/A';
            const getStatusKategori = (res) => res?.classification || 'N/A';

            filteredProfiles.forEach((data, index) => {
                const status = data.lastStatus || {};
                
                // Ambil data status yang aktif berdasarkan radio button view
                const activeStatus = status[selectedIndex] || {};
                
                const zScore = getZScoreDisplay(activeStatus);
                const classificationText = getStatusKategori(activeStatus);
                const activeZScore = activeStatus?.zScore;
                
                // Hitung usia untuk tampilan tabel
                const ageResultForTable = calculateAge(data.dob); 
                const ageDisplayForTable = ageResultForTable ? ageResultForTable.display : 'Tgl Salah';


                const row = document.createElement('tr');
                row.className = 'border-t hover:bg-gray-50 cursor-pointer';
                
                // Handler klik baris (muat data)
                row.onclick = (e) => {
                    // Cek jika target bukan tombol atau input (untuk mencegah load saat klik radio/tombol hapus)
                    if (e.target.tagName !== 'BUTTON' && e.target.type !== 'radio' && e.target.tagName !== 'INPUT') {
                        window.loadChildData(data.id, data);
                    }
                };
                
                // Menentukan warna latar belakang status berdasarkan Z-score TERPILIH
                let statusBgClass = 'bg-gray-100'; 
                if (activeZScore !== 'N/A' && typeof activeZScore === 'number') {
                    if (selectedIndex === 'HFA') { // Logic Stunting
                        if (activeZScore < -3) statusBgClass = 'bg-red-100';
                        else if (activeZScore < -2) statusBgClass = 'bg-yellow-100';
                        else statusBgClass = 'bg-green-50';
                    } else { // Logic WFA, WFL, BFA
                        if (activeZScore < -3 || activeZScore > 2) statusBgClass = 'bg-red-100';
                        else if (activeZScore < -2 || activeZScore > 1) statusBgClass = 'bg-yellow-100';
                        else statusBgClass = 'bg-green-50';
                    }
                }

                // 3. GENERATE KONTEN BARIS SESUAI 7 KOLOM
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td class="font-medium truncate">${data.name}</td>
                    <td>${data.sex === 'male' ? 'L' : 'P'}</td>
                    <td class="text-center">${ageDisplayForTable}</td>
                    <td class="text-center">${zScore}</td>
                    <td id="status_cell_${data.id}" class="${statusBgClass} font-bold">${classificationText}</td>
                    <td>
                        <button type="button" class="text-red-500 hover:text-red-700 font-bold text-xs" 
                            onclick="window.showDeleteModal('${data.id}', '${data.name}', event)">Hapus</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        /** Fungsi baru untuk mengatur indeks tabel yang dipilih */
        window.setTableIndex = function(index) {
            window.currentTableIndex = index;
            window.renderChildList();
        }


        /** Memfilter daftar anak. */
        window.filterChildList = function() {
            window.renderChildList();
        }

        /** Loads all child profiles for the current user in real-time. */
        window.loadChildProfiles = function() {
            if (!window.userId) return;

            const q = query(collection(db, 'artifacts', appId, 'users', window.userId, 'children'));
            
            onSnapshot(q, (snapshot) => {
                window.allChildProfiles = [];
                snapshot.docs.forEach(doc => {
                    window.allChildProfiles.push({ id: doc.id, ...doc.data() });
                });
                // Sort profiles by save time (newest first)
                window.allChildProfiles.sort((a, b) => b.savedAt.toDate() - a.savedAt.toDate());

                window.renderChildList();
            }, (error) => {
                console.error("Error listening to documents: ", error);
                const tbody = document.getElementById('child-list');
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-red-500 p-2">Gagal memuat profil.</td></tr>'; // Updated colspan
            });
        }
        
        /** Clears the current data and sets a new child profile mode. */
        window.clearCurrentChild = function() {
            window.hideDeleteModal();
            window.hideValidationModal();
            window.currentChildId = null;
            
            // Set input kosong kecuali JK
            document.getElementById('child-name').value = '';
            document.getElementById('dob').value = MASK_DEFAULT; // Menggunakan MASK_DEFAULT
            document.getElementById('sex').value = 'male';
            document.getElementById('weight').value = '';
            document.getElementById('height').value = '';
            
            window.calculateNutritionStatus();
            document.getElementById('profile-search').value = ''; // Clear search field
            window.renderChildList(); // Rerender list
        }
        
        // Start Firebase setup
        window.setupFirebase();

    </script>
    <!-- End of Module Script -->


    <script>
        // Batas Usia Maksimal: 19 tahun * 12 bulan = 228 bulan
        const MAX_AGE_MONTHS = 228;

        // --- Variabel Masking TTL ---
        const MASK_DEFAULT = 'HH/BB/TTTT';
        const MASK = '__/__/____';
        const SLOT_IDX = [0,1,3,4,6,7,8,9]; // posisi angka

        // --- FUNGSI MASKING TTL ---
        const el = document.getElementById('dob');

        function setCaret(pos){ requestAnimationFrame(()=> el.setSelectionRange(pos,pos)); }

        function nextSlot(from){
          for (let i=from; i<el.value.length; i++){
            if (SLOT_IDX.includes(i) && el.value[i] === '_') return i;
          }
          return -1;
        }
        function prevSlot(from){
          for (let i=from-1; i>=0; i--){
            if (SLOT_IDX.includes(i)) return i;
          }
          return -1;
        }

        // Saat fokus: ganti hh/bb/tttt -> __/__/____
        el.addEventListener('focus', () => {
          if (el.value === MASK_DEFAULT) el.value = MASK;
          // taruh kursor di slot kosong pertama
          const ns = nextSlot(0);
          setCaret(ns === -1 ? el.value.length : ns);
        });

        // Jika kosongkan lalu keluar: balikin ke hh/bb/tttt
        el.addEventListener('blur', () => {
          const isMaskedAndEmpty = el.value.replace(/\//g,'').replace(/_/g,'').length === 0;
          if (el.value === MASK || isMaskedAndEmpty) {
            el.value = MASK_DEFAULT;
          }
          // Panggil perhitungan setelah blur untuk validasi terakhir
          window.calculateNutritionStatus(); 
        });

        // Handler utama pengetikan
        el.addEventListener('keydown', (e) => {
          const k = e.key;
          const start = el.selectionStart;
          const end = el.selectionEnd;

          // Panggil calculateNutritionStatus() untuk update real-time
          // Dijalankan di requestAnimationFrame agar DOM update duluan
          requestAnimationFrame(() => window.calculateNutritionStatus());

          // Blokir edit langsung pada "/" (biar "/" tidak hilang)
          if ((start === 2 || start === 5) && (k === 'Backspace' || k === 'Delete')) {
            e.preventDefault(); return;
          }

          // Izinkan navigasi
          const navKeys = ['ArrowLeft','ArrowRight','Home','End','Tab'];
          if (navKeys.includes(k)) return;

          // Angka: taruh ke slot "_" berikutnya
          if (/^\d$/.test(k)) {
            e.preventDefault();

            // kalau ada selection, hapus isinya dulu (ganti jadi "_")
            if (end > start){
              let arr = el.value.split('');
              for (let i=start; i<end; i++){
                if (SLOT_IDX.includes(i)) arr[i] = '_';
              }
              el.value = arr.join('');
            }

            // target slot = slot kosong pertama dari posisi kursor
            let pos = nextSlot(start);
            if (pos === -1) return; // sudah penuh

            let arr = el.value.split('');
            arr[pos] = k;
            el.value = arr.join('');

            // lompat ke slot berikutnya, auto-skip "/"
            const after = nextSlot(pos+1);
            setCaret(after === -1 ? pos+1 : after);
            return;
          }

          // Backspace: kosongkan slot angka sebelumnya dan pindah ke sana
          if (k === 'Backspace') {
            e.preventDefault();
            let pos = prevSlot(start);
            if (pos === -1) return;
            let arr = el.value.split('');
            arr[pos] = '_';
            el.value = arr.join('');
            setCaret(pos);
            return;
          }

          // Delete: kosongkan slot di posisi kursor (kalau slot angka)
          if (k === 'Delete') {
            e.preventDefault();
            if (SLOT_IDX.includes(start)){
              let arr = el.value.split('');
              arr[start] = '_';
              el.value = arr.join('');
              setCaret(start);
            }
            return;
          }

          // Blokir semua input non-angka/non-navigasi
          e.preventDefault();
        });

        // Jaga agar user tidak bisa paste sembarang: hanya ambil digit
        el.addEventListener('paste', (e) => {
          e.preventDefault();
          const text = (e.clipboardData || window.clipboardData).getData('text') || '';
          const digits = text.replace(/\D/g,'').slice(0,8); // maksimal 8 digit
          if (!digits) return;

          let arr = el.value.split('');
          let idx = nextSlot(el.selectionStart);
          if (idx === -1) idx = nextSlot(0);
          let p = idx;
          for (let d of digits){
            if (p === -1) break;
            arr[p] = d;
            p = nextSlot(p+1);
          }
          el.value = arr.join('');
          setCaret(p === -1 ? 10 : p);
          // Panggil perhitungan setelah paste
          window.calculateNutritionStatus(); 
        });

        // --- DATA REFERENSI WHO-LMS ---

        // BB/U - Laki-laki (WFA Male 0-60m)
        const WFA_M_LMS = [
            [0, 1.156, 3.322, 0.145], [1, 1.146, 4.545, 0.141], [2, 1.132, 5.666, 0.136], [3, 1.111, 6.592, 0.131], [4, 1.085, 7.301, 0.126], 
            [5, 1.057, 7.828, 0.122], [6, 1.026, 8.243, 0.118], [7, 0.993, 8.579, 0.114], [8, 0.960, 8.859, 0.111], [9, 0.925, 9.102, 0.108], 
            [10, 0.891, 9.319, 0.106], [11, 0.855, 9.516, 0.104], [12, 0.820, 9.697, 0.102], [13, 0.784, 9.866, 0.101], [14, 0.749, 10.024, 0.099], 
            [15, 0.713, 10.174, 0.098], [16, 0.678, 10.316, 0.097], [17, 0.643, 10.453, 0.096], [18, 0.609, 10.584, 0.095], [19, 0.575, 10.712, 0.094], 
            [20, 0.542, 10.835, 0.093], [21, 0.510, 10.956, 0.093], [22, 0.477, 11.075, 0.092], [23, 0.446, 11.192, 0.092], [24, 0.415, 11.309, 0.091], 
            [25, 0.384, 11.424, 0.091], [26, 0.354, 11.539, 0.090], [27, 0.325, 11.652, 0.090], [28, 0.297, 11.764, 0.090], [29, 0.270, 11.875, 0.089], 
            [30, 0.243, 11.984, 0.089], [31, 0.217, 12.093, 0.089], [32, 0.191, 12.200, 0.089], [33, 0.166, 12.307, 0.088], [34, 0.142, 12.413, 0.088], 
            [35, 0.118, 12.517, 0.088], [36, 0.095, 12.621, 0.088], [37, 0.073, 12.724, 0.088], [38, 0.051, 12.825, 0.087], [39, 0.030, 12.926, 0.087], 
            [40, 0.010, 13.026, 0.087], [41, -0.009, 13.124, 0.087], [42, -0.027, 13.222, 0.087], [43, -0.044, 13.319, 0.087], [44, -0.061, 13.415, 0.087], 
            [45, -0.076, 13.510, 0.087], [46, -0.090, 13.605, 0.087], [47, -0.103, 13.698, 0.087], [48, -0.115, 13.790, 0.087], [49, -0.125, 13.881, 0.088], 
            [50, -0.134, 13.971, 0.088], [51, -0.142, 14.060, 0.088], [52, -0.149, 14.148, 0.088], [53, -0.154, 14.234, 0.088], [54, -0.158, 14.320, 0.089], 
            [55, -0.160, 14.404, 0.089], [56, -0.161, 14.487, 0.089], [57, -0.160, 14.568, 0.089], [58, -0.157, 14.648, 0.090], [59, -0.153, 14.727, 0.090], 
            [60, -0.148, 14.805, 0.090]
        ];

        // BB/U - Perempuan (WFA Female 0-60m)
        const WFA_F_LMS = [
            [0, 0.941, 3.230, 0.155], [1, 0.963, 4.225, 0.150], [2, 0.963, 5.176, 0.143], [3, 0.942, 5.952, 0.137], [4, 0.905, 6.551, 0.131], 
            [5, 0.849, 7.025, 0.126], [6, 0.810, 7.422, 0.122], [7, 0.757, 7.765, 0.118], [8, 0.702, 8.058, 0.114], [9, 0.647, 8.320, 0.111], 
            [10, 0.592, 8.561, 0.108], [11, 0.537, 8.784, 0.106], [12, 0.483, 8.995, 0.104], [13, 0.430, 9.196, 0.103], [14, 0.379, 9.387, 0.101], 
            [15, 0.329, 9.570, 0.100], [16, 0.281, 9.746, 0.099], [17, 0.235, 9.916, 0.098], [18, 0.191, 10.080, 0.097], [19, 0.149, 10.240, 0.096], 
            [20, 0.109, 10.395, 0.095], [21, 0.071, 10.547, 0.095], [22, 0.034, 10.695, 0.094], [23, -0.001, 10.840, 0.093], [24, -0.035, 10.983, 0.093], 
            [25, -0.068, 11.123, 0.092], [26, -0.100, 11.262, 0.092], [27, -0.130, 11.399, 0.092], [28, -0.158, 11.534, 0.091], [29, -0.185, 11.667, 0.091], 
            [30, -0.209, 11.799, 0.091], [31, -0.232, 11.930, 0.091], [32, -0.253, 12.059, 0.090], [33, -0.273, 12.187, 0.090], [34, -0.290, 12.313, 0.090], 
            [35, -0.306, 12.438, 0.090], [36, -0.319, 12.562, 0.090], [37, -0.330, 12.684, 0.090], [38, -0.339, 12.805, 0.090], [39, -0.345, 12.925, 0.090], 
            [40, -0.349, 13.044, 0.090], [41, -0.350, 13.161, 0.090], [42, -0.349, 13.277, 0.090], [43, -0.345, 13.392, 0.090], [44, -0.339, 13.506, 0.090], 
            [45, -0.331, 13.619, 0.090], [46, -0.320, 13.730, 0.090], [47, -0.308, 13.840, 0.091], [48, -0.294, 13.948, 0.091], [49, -0.278, 14.055, 0.091], 
            [50, -0.260, 14.161, 0.091], [51, -0.241, 14.265, 0.091], [52, -0.220, 14.367, 0.091], [53, -0.198, 14.468, 0.091], [54, -0.175, 14.567, 0.091], 
            [55, -0.150, 14.665, 0.091], [56, -0.125, 14.761, 0.091], [57, -0.098, 14.856, 0.091], [58, -0.071, 14.949, 0.091], [59, -0.043, 15.040, 0.091], 
            [60, -0.014, 15.131, 0.091]
        ];

        // TB/U - Laki-laki (HFA Male 0-60m)
        const HFA_M_LMS_0_60 = [
            [0, 0.141, 49.988, 0.038], [1, 0.167, 54.729, 0.035], [2, 0.167, 58.423, 0.034], [3, 0.153, 61.353, 0.033], [4, 0.134, 63.673, 0.033], 
            [5, 0.114, 65.520, 0.033], [6, 0.095, 67.016, 0.033], [7, 0.076, 68.257, 0.033], [8, 0.059, 69.309, 0.034], [9, 0.043, 70.217, 0.034], 
            [10, 0.029, 71.018, 0.034], [11, 0.016, 71.734, 0.035], [12, 0.005, 72.385, 0.035], [13, -0.004, 72.984, 0.035], [14, -0.013, 73.541, 0.036], 
            [15, -0.020, 74.062, 0.036], [16, -0.027, 74.551, 0.036], [17, -0.032, 75.013, 0.037], [18, -0.037, 75.452, 0.037], [19, -0.041, 75.871, 0.037], 
            [20, -0.044, 76.273, 0.038], [21, -0.046, 76.660, 0.038], [22, -0.047, 77.034, 0.038], [23, -0.048, 77.397, 0.038], [24, -0.047, 77.750, 0.039], 
            [25, -0.047, 78.094, 0.039], [26, -0.045, 78.430, 0.039], [27, -0.043, 78.759, 0.039], [28, -0.040, 79.081, 0.039], [29, -0.037, 79.398, 0.039], 
            [30, -0.033, 79.709, 0.039], [31, -0.028, 80.015, 0.040], [32, -0.024, 80.316, 0.040], [33, -0.019, 80.613, 0.040], [34, -0.014, 80.906, 0.040], 
            [35, -0.009, 81.194, 0.040], [36, -0.028, 81.478, 0.040], [37, 0.001, 81.758, 0.040], [38, 0.006, 82.035, 0.040], [39, 0.010, 82.308, 0.040], 
            [40, 0.014, 82.578, 0.040], [41, 0.018, 82.845, 0.040], [42, 0.021, 83.109, 0.040], [43, 0.024, 83.370, 0.040], [44, 0.026, 83.628, 0.040], 
            [45, 0.027, 83.883, 0.040], [46, 0.029, 84.135, 0.040], [47, 0.030, 84.385, 0.040], [48, 0.030, 84.632, 0.040], [49, 0.030, 84.876, 0.040], 
            [50, 0.029, 85.118, 0.040], [51, 0.028, 85.358, 0.040], [52, 0.027, 85.595, 0.040], [53, 0.025, 85.830, 0.040], [54, 0.023, 86.063, 0.040], 
            [55, 0.020, 86.293, 0.040], [56, 0.017, 86.522, 0.040], [57, 0.014, 86.748, 0.040], [58, 0.010, 86.972, 0.040], [59, 0.006, 87.195, 0.040], 
            [60, 0.002, 87.416, 0.040]
        ];
        
        // TB/U - Perempuan (HFA Female 0-60m)
        const HFA_F_LMS_0_60 = [
            [0, 0.021, 49.255, 0.040], [1, 0.082, 53.681, 0.036], [2, 0.106, 57.112, 0.034], [3, 0.108, 59.789, 0.033], [4, 0.101, 61.884, 0.033], 
            [5, 0.090, 63.565, 0.033], [6, 0.076, 64.957, 0.033], [7, 0.061, 66.143, 0.034], [8, 0.045, 67.172, 0.034], [9, 0.030, 68.083, 0.034], 
            [10, 0.016, 68.900, 0.035], [11, 0.003, 69.643, 0.035], [12, -0.009, 70.325, 0.036], [13, -0.020, 70.957, 0.036], [14, -0.030, 71.547, 0.036], 
            [15, -0.039, 72.102, 0.037], [16, -0.046, 72.627, 0.037], [17, -0.053, 73.125, 0.037], [18, -0.058, 73.600, 0.038], [19, -0.062, 74.053, 0.038], 
            [20, -0.066, 74.486, 0.038], [21, -0.068, 74.901, 0.039], [22, -0.069, 75.300, 0.039], [23, -0.070, 75.684, 0.039], [24, -0.070, 76.054, 0.039], 
            [25, -0.069, 76.411, 0.039], [26, -0.068, 76.756, 0.039], [27, -0.066, 77.090, 0.040], [28, -0.064, 77.414, 0.040], [29, -0.061, 77.728, 0.040], 
            [30, -0.058, 78.032, 0.040], [31, -0.054, 78.328, 0.040], [32, -0.050, 78.614, 0.040], [33, -0.045, 78.892, 0.040], [34, -0.040, 79.161, 0.040], 
            [35, -0.034, 79.423, 0.040], [36, -0.028, 79.677, 0.040], [37, -0.021, 79.924, 0.040], [38, -0.014, 80.165, 0.040], [39, -0.007, 80.398, 0.040], 
            [40, 0.000, 80.626, 0.040], [41, 0.007, 80.847, 0.040], [42, 0.013, 81.062, 0.040], [43, 0.019, 81.272, 0.040], [44, 0.025, 81.477, 0.040], 
            [45, 0.031, 81.677, 0.040], [46, 0.036, 81.872, 0.040], [47, 0.041, 82.063, 0.040], [48, 0.045, 82.250, 0.040], [49, 0.049, 82.433, 0.040], 
            [50, 0.052, 82.612, 0.040], [51, 0.054, 82.787, 0.040], [52, 0.057, 82.959, 0.040], [53, 0.058, 83.128, 0.040], [54, 0.060, 83.294, 0.040], 
            [55, 0.060, 83.457, 0.040], [56, 0.061, 83.618, 0.040], [57, 0.060, 83.776, 0.040], [58, 0.060, 83.932, 0.040], [59, 0.059, 84.085, 0.040], 
            [60, 0.057, 84.237, 0.040]
        ];

        // BB/TB - Laki-laki (WFL Male 45-110cm)
        const WFL_M_LMS = [
            [45.0, 0.280, 2.756, 0.176], [45.5, 0.280, 2.859, 0.174], [46.0, 0.280, 2.964, 0.172], [46.5, 0.280, 3.072, 0.170], [47.0, 0.280, 3.181, 0.169],
            [47.5, 0.280, 3.292, 0.167], [48.0, 0.280, 3.404, 0.165], [48.5, 0.280, 3.517, 0.163], [49.0, 0.280, 3.631, 0.162], [49.5, 0.280, 3.746, 0.160],
            [50.0, 0.280, 3.861, 0.158], [50.5, 0.280, 3.977, 0.157], [51.0, 0.280, 4.094, 0.155], [51.5, 0.280, 4.212, 0.154], [52.0, 0.280, 4.330, 0.152],
            [52.5, 0.280, 4.449, 0.151], [53.0, 0.280, 4.568, 0.149], [53.5, 0.280, 4.688, 0.148], [54.0, 0.280, 4.809, 0.147], [54.5, 0.280, 4.930, 0.145],
            [55.0, 0.280, 5.051, 0.144], [55.5, 0.280, 5.174, 0.143], [56.0, 0.280, 5.297, 0.142], [56.5, 0.280, 5.420, 0.141], [57.0, 0.280, 5.544, 0.140],
            [57.5, 0.279, 5.669, 0.139], [58.0, 0.279, 5.794, 0.138], [58.5, 0.278, 5.920, 0.137], [59.0, 0.278, 6.046, 0.136], [59.5, 0.277, 6.173, 0.135],
            [60.0, 0.277, 6.301, 0.135], [60.5, 0.276, 6.429, 0.134], [61.0, 0.276, 6.558, 0.133], [61.5, 0.275, 6.688, 0.133], [62.0, 0.275, 6.818, 0.132],
            [62.5, 0.274, 6.949, 0.132], [63.0, 0.274, 7.081, 0.131], [63.5, 0.273, 7.213, 0.131], [64.0, 0.273, 7.346, 0.130], [64.5, 0.272, 7.479, 0.130],
            [65.0, 0.272, 7.613, 0.129], [65.5, 0.271, 7.747, 0.129], [66.0, 0.271, 7.882, 0.129], [66.5, 0.270, 8.017, 0.128], [67.0, 0.270, 8.153, 0.128],
            [67.5, 0.269, 8.289, 0.128], [68.0, 0.269, 8.426, 0.127], [68.5, 0.268, 8.563, 0.127], [69.0, 0.268, 8.701, 0.127], [69.5, 0.267, 8.839, 0.127],
            [70.0, 0.267, 8.977, 0.126], [70.5, 0.266, 9.116, 0.126], [71.0, 0.266, 9.255, 0.126], [71.5, 0.266, 9.395, 0.126], [72.0, 0.265, 9.535, 0.126],
            [72.5, 0.265, 9.675, 0.126], [73.0, 0.265, 9.816, 0.126], [73.5, 0.264, 9.957, 0.126], [74.0, 0.264, 10.098, 0.126], [74.5, 0.264, 10.239, 0.126],
            [75.0, 0.264, 10.381, 0.126], [75.5, 0.263, 10.523, 0.126], [76.0, 0.263, 10.665, 0.126], [76.5, 0.263, 10.808, 0.126], [77.0, 0.263, 10.950, 0.127],
            [77.5, 0.263, 11.093, 0.127], [78.0, 0.263, 11.236, 0.127], [78.5, 0.263, 11.379, 0.127], [79.0, 0.263, 11.523, 0.127], [79.5, 0.263, 11.666, 0.127],
            [80.0, 0.263, 11.810, 0.128], [80.5, 0.263, 11.954, 0.128], [81.0, 0.264, 12.098, 0.128], [81.5, 0.264, 12.242, 0.128], [82.0, 0.264, 12.387, 0.129],
            [82.5, 0.265, 12.532, 0.129], [83.0, 0.265, 12.677, 0.129], [83.5, 0.266, 12.822, 0.129], [84.0, 0.266, 12.968, 0.130], [84.5, 0.267, 13.113, 0.130],
            [85.0, 0.267, 13.259, 0.130], [85.5, 0.268, 13.406, 0.131], [86.0, 0.269, 13.552, 0.131], [86.5, 0.270, 13.699, 0.132], [87.0, 0.270, 13.846, 0.132],
            [87.5, 0.271, 13.993, 0.133], [88.0, 0.272, 14.140, 0.133], [88.5, 0.273, 14.288, 0.134], [89.0, 0.274, 14.436, 0.134], [89.5, 0.275, 14.584, 0.135],
            [90.0, 0.276, 14.732, 0.135], [90.5, 0.277, 14.880, 0.136], [91.0, 0.278, 15.029, 0.136], [91.5, 0.279, 15.178, 0.137], [92.0, 0.280, 15.328, 0.137],
            [92.5, 0.281, 15.478, 0.138], [93.0, 0.282, 15.628, 0.138], [93.5, 0.283, 15.779, 0.139], [94.0, 0.284, 15.930, 0.139], [94.5, 0.285, 16.081, 0.140],
            [95.0, 0.286, 16.233, 0.140], [95.5, 0.287, 16.385, 0.141], [96.0, 0.288, 16.537, 0.141], [96.5, 0.289, 16.690, 0.142], [97.0, 0.290, 16.843, 0.142],
            [97.5, 0.291, 16.997, 0.143], [98.0, 0.292, 17.151, 0.143], [98.5, 0.293, 17.306, 0.144], [99.0, 0.294, 17.460, 0.144], [99.5, 0.295, 17.616, 0.145],
            [100.0, 0.296, 17.771, 0.145], [100.5, 0.297, 17.928, 0.146], [101.0, 0.298, 18.084, 0.146], [101.5, 0.299, 18.241, 0.147], [102.0, 0.300, 18.399, 0.147],
            [102.5, 0.301, 18.557, 0.148], [103.0, 0.302, 18.716, 0.148], [103.5, 0.303, 18.875, 0.149], [104.0, 0.304, 19.035, 0.149], [104.5, 0.305, 19.195, 0.150],
            [105.0, 0.306, 19.356, 0.150], [105.5, 0.307, 19.518, 0.151], [106.0, 0.308, 19.680, 0.151], [106.5, 0.309, 19.843, 0.152], [107.0, 0.310, 20.006, 0.152],
            [107.5, 0.311, 20.170, 0.153], [108.0, 0.312, 20.334, 0.153], [108.5, 0.313, 20.500, 0.154], [109.0, 0.314, 20.665, 0.154], [109.5, 0.315, 20.832, 0.155],
            [110.0, 0.316, 20.999, 0.155]
        ];

        // IMT/U - Laki-laki (BFA Male 0-60m)
        const BFA_M_LMS_0_60 = [
            [0, 0.697, 13.565, 0.106], [1, 0.732, 15.341, 0.096], [2, 0.724, 16.510, 0.092], [3, 0.701, 17.203, 0.090], [4, 0.668, 17.587, 0.089], 
            [5, 0.627, 17.765, 0.089], [6, 0.584, 17.828, 0.088], [7, 0.539, 17.826, 0.088], [8, 0.493, 17.788, 0.087], [9, 0.447, 17.725, 0.087], 
            [10, 0.401, 17.643, 0.087], [11, 0.355, 17.551, 0.086], [12, 0.309, 17.452, 0.086], [13, 0.264, 17.351, 0.086], [14, 0.220, 17.250, 0.086], 
            [15, 0.177, 17.150, 0.086], [16, 0.136, 17.051, 0.086], [17, 0.096, 16.955, 0.086], [18, 0.058, 16.862, 0.086], [19, 0.021, 16.772, 0.086], 
            [20, -0.013, 16.685, 0.086], [21, -0.045, 16.602, 0.086], [22, -0.076, 16.522, 0.086], [23, -0.104, 16.446, 0.086], [24, -0.131, 16.373, 0.086], 
            [25, -0.155, 16.304, 0.087], [26, -0.178, 16.239, 0.087], [27, -0.198, 16.178, 0.087], [28, -0.217, 16.120, 0.087], [29, -0.233, 16.066, 0.087], 
            [30, -0.248, 16.015, 0.087], [31, -0.260, 15.967, 0.088], [32, -0.270, 15.923, 0.088], [33, -0.279, 15.882, 0.088], [34, -0.285, 15.844, 0.088], 
            [35, -0.290, 15.808, 0.089], [36, -0.293, 15.776, 0.089], [37, -0.294, 15.746, 0.089], [38, -0.293, 15.719, 0.089], [39, -0.290, 15.695, 0.089], 
            [40, -0.286, 15.673, 0.090], [41, -0.280, 15.653, 0.090], [42, -0.273, 15.636, 0.090], [43, -0.264, 15.621, 0.090], [44, -0.254, 15.608, 0.090], 
            [45, -0.298, 14.511, 0.085], [46, -0.277, 14.492, 0.085], [47, -0.255, 14.475, 0.086], [48, -0.232, 14.461, 0.086], [49, -0.208, 14.449, 0.086], 
            [50, -0.183, 14.438, 0.086], [51, -0.158, 14.430, 0.086], [52, -0.132, 14.423, 0.087], [53, -0.105, 14.419, 0.087], [54, -0.078, 14.417, 0.087], 
            [55, -0.051, 14.416, 0.087], [56, -0.023, 14.417, 0.087], [57, 0.005, 14.420, 0.088], [58, 0.033, 14.424, 0.088], [59, 0.062, 14.430, 0.088], 
            [60, 0.091, 14.438, 0.088]
        ];

        // IMT/U - Perempuan (BFA Female 0-60m)
        const BFA_F_LMS_0_60 = [
            [0, 0.584, 13.060, 0.108], [1, 0.635, 14.545, 0.099], [2, 0.630, 15.510, 0.093], [3, 0.601, 16.037, 0.090], [4, 0.553, 16.311, 0.088], 
            [5, 0.495, 16.425, 0.087], [6, 0.433, 16.452, 0.086], [7, 0.369, 16.442, 0.085], [8, 0.306, 16.415, 0.084], [9, 0.244, 16.376, 0.084], 
            [10, 0.184, 16.328, 0.083], [11, 0.126, 16.273, 0.083], [12, 0.069, 16.213, 0.083], [13, 0.015, 16.149, 0.083], [14, -0.038, 16.082, 0.082], 
            [15, -0.087, 16.014, 0.082], [16, -0.133, 15.944, 0.082], [17, -0.176, 15.874, 0.082], [18, -0.216, 15.803, 0.082], [19, -0.252, 15.733, 0.082], 
            [20, -0.286, 15.663, 0.082], [21, -0.317, 15.594, 0.082], [22, -0.344, 15.526, 0.082], [23, -0.368, 15.460, 0.082], [24, -0.390, 15.394, 0.082], 
            [25, -0.408, 15.331, 0.082], [26, -0.424, 15.269, 0.082], [27, -0.437, 15.210, 0.082], [28, -0.447, 15.152, 0.082], [29, -0.455, 15.097, 0.082], 
            [30, -0.460, 15.044, 0.083], [31, -0.463, 14.994, 0.083], [32, -0.463, 14.945, 0.083], [33, -0.461, 14.899, 0.083], [34, -0.457, 14.855, 0.083], 
            [35, -0.450, 14.814, 0.083], [36, -0.442, 14.774, 0.083], [37, -0.431, 14.737, 0.084], [38, -0.419, 14.701, 0.084], [39, -0.405, 14.668, 0.084], 
            [40, -0.390, 14.637, 0.084], [41, -0.374, 14.607, 0.084], [42, -0.357, 14.580, 0.085], [43, -0.338, 14.555, 0.085], [44, -0.319, 14.532, 0.085], 
            [45, -0.298, 14.511, 0.085], [46, -0.277, 14.492, 0.085], [47, -0.255, 14.475, 0.086], [48, -0.232, 14.461, 0.086], [49, -0.208, 14.449, 0.086], 
            [50, -0.183, 14.438, 0.086], [51, -0.158, 14.430, 0.086], [52, -0.132, 14.423, 0.087], [53, -0.105, 14.419, 0.087], [54, -0.078, 14.417, 0.087], 
            [55, -0.051, 14.416, 0.087], [56, -0.023, 14.417, 0.087], [57, 0.005, 14.420, 0.088], [58, 0.033, 14.424, 0.088], [59, 0.062, 14.430, 0.088], 
            [60, 0.091, 14.438, 0.088]
        ];

        // --- DATA LMS WHO REFERENCE 5-19 TAHUN (Interpolasi berdasarkan tabel WHO) ---
        // Poin data TB/U (HFA) Male 61-228m
        const HFA_M_LMS_61_228_POINTS = [
            [60, 0.002, 114.6, 0.040], [72, -0.016, 120.3, 0.042], [84, -0.027, 125.4, 0.045], [96, -0.035, 130.3, 0.047], 
            [108, -0.041, 135.2, 0.049], [120, -0.046, 140.0, 0.051], [132, -0.050, 145.0, 0.052], [144, -0.053, 150.1, 0.053], 
            [156, -0.055, 155.0, 0.053], [168, -0.057, 160.0, 0.053], [180, -0.058, 165.0, 0.052], [192, -0.059, 168.9, 0.051],
            [204, -0.060, 171.6, 0.050], [216, -0.061, 173.4, 0.049], [228, -0.062, 174.4, 0.048]
        ];
        
        // Poin data TB/U (HFA) Female 61-228m
        const HFA_F_LMS_61_228_POINTS = [
            [60, 0.057, 113.6, 0.040], [72, 0.040, 119.3, 0.042], [84, 0.028, 124.3, 0.044], [96, 0.021, 129.2, 0.046], 
            [108, 0.017, 134.1, 0.048], [120, 0.014, 139.0, 0.050], [132, 0.011, 143.9, 0.051], [144, 0.008, 148.8, 0.051], 
            [156, 0.005, 152.7, 0.051], [168, 0.003, 155.1, 0.050], [180, 0.000, 156.4, 0.049], [192, -0.001, 157.0, 0.048],
            [204, -0.002, 157.3, 0.047], [216, -0.003, 157.4, 0.046], [228, -0.004, 157.4, 0.045]
        ];
        
        // Poin data IMT/U (BFA) Male 61-228m
        const BFA_M_LMS_61_228_POINTS = [
            [60, 0.016, 15.68, 0.094], [72, -0.049, 15.93, 0.096], [84, -0.099, 16.20, 0.099], [96, -0.137, 16.51, 0.103],
            [108, -0.165, 16.89, 0.108], [120, -0.179, 17.34, 0.114], [132, -0.175, 17.84, 0.121], [144, -0.149, 18.42, 0.129],
            [156, -0.096, 19.10, 0.138], [168, -0.011, 19.86, 0.148], [180, 0.113, 20.67, 0.160], [192, 0.231, 21.46, 0.173],
            [204, 0.329, 22.14, 0.187], [216, 0.401, 22.66, 0.201], [228, 0.435, 22.95, 0.216]
        ];
        
        // Poin data IMT/U (BFA) Female 61-228m
        const BFA_F_LMS_61_228_POINTS = [
            [60, 0.091, 14.44, 0.088], [72, 0.026, 14.88, 0.090], [84, -0.023, 15.39, 0.094], [96, -0.052, 15.97, 0.098],
            [108, -0.052, 16.63, 0.105], [120, -0.017, 17.33, 0.112], [132, 0.053, 18.06, 0.120], [144, 0.150, 18.78, 0.129],
            [156, 0.264, 19.45, 0.139], [168, 0.380, 20.03, 0.150], [180, 0.490, 20.51, 0.162], [192, 0.587, 20.89, 0.174],
            [204, 0.659, 21.14, 0.186], [216, 0.706, 21.28, 0.199], [228, 0.729, 21.34, 0.212]
        ];


        // --- GLOBAL STATE ---
        let currentAgeMonths = 0;
        window.currentZScoreResults = {};
        window.lmsDataCache = {}; // Cache for LMS data based on index and sex
        window.currentTableIndex = 'WFA'; // Default index for table view
        
        // UTILITY: Format Date to ISO String (Dipindahkan ke sini agar tersedia global sebelum window.onload)
        window.dateToISO = (date) => date.toISOString().split('T')[0];

        // --- FUNGSI DATE MASKING LAMA (DIHAPUS, DIGANTI EVENT LISTENER DI BAWAH) ---
        
        // --- FUNGSI MESSAGE BOX UTILITY (GLOBAL) ---
        function showMessage(text, type = 'info') {
            const messageBox = document.getElementById('message-box');
            let bgClass, borderClass, textClass;

            if (type === 'success') {
                bgClass = 'bg-green-100';
                borderClass = 'border-success';
                textClass = 'text-green-800';
            } else if (type === 'danger') {
                bgClass = 'bg-red-100';
                borderClass = 'border-danger';
                textClass = 'text-red-800';
            } else if (type === 'warning') {
                bgClass = 'bg-yellow-100';
                borderClass = 'border-warning';
                textClass = 'text-yellow-800';
            } else { // info/default
                bgClass = 'bg-blue-100';
                borderClass = 'border-info';
                textClass = 'text-blue-800';
            }

            messageBox.innerHTML = `<span class="${textClass}">${text}</span>`;
            messageBox.className = `p-3 text-sm rounded-lg border-l-4 ${bgClass} ${borderClass}`;

            // Simple reset to default green state after 3 seconds
            setTimeout(() => {
                messageBox.innerHTML = 'Masukkan data antropometri anak (Nama, TTL, BB, TB/PB) untuk memulai perhitungan status gizi.';
                messageBox.className = 'p-3 text-sm text-green-800 bg-green-100 border-l-4 border-success rounded-lg';
            }, 3000);
        }
        window.showMessage = showMessage;
        
        // --- FUNGSI COPY DATA (BARU) ---
        window.copyFilteredDataToClipboard = function() {
            const index = window.currentTableIndex;
            const profiles = window.allChildProfiles;

            if (profiles.length === 0) {
                window.showMessage('Tidak ada data profil yang tersimpan untuk disalin.', 'warning');
                return;
            }

            // Headers
            const headerIndex = {
                'WFA': 'BB/U (Z)',
                'HFA': 'TB/U (Z)',
                'WFL': 'BB/TB (Z)',
                'BFA': 'IMT/U (Z)'
            };

            let tsv = ['No', 'Nama', 'JK', 'Tgl Lahir (HH/BB/TTTT)', 'BB (kg)', 'TB/PB (cm)', 'Umur', headerIndex[index], 'Status'].join('\t') + '\n';
            
            profiles.forEach((data, i) => {
                const status = data.lastStatus[index] || {};
                const zScore = status.zScore === 'N/A' || typeof status.zScore !== 'number' ? 'N/A' : status.zScore.toFixed(2);
                const classification = status.classification || 'N/A';
                
                // Konversi tanggal ISO (YYYY-MM-DD) kembali ke HH/BB/TTTT untuk display
                const dobDisplay = window.dateToDMY(data.dob); 
                const ageResultForTable = calculateAge(data.dob);
                const ageDisplayForTable = ageResultForTable ? ageResultForTable.display : 'Tgl Salah';
                
                const row = [
                    i + 1,
                    data.name,
                    data.sex === 'male' ? 'L' : 'P',
                    dobDisplay,
                    data.weight,
                    data.height,
                    ageDisplayForTable,
                    zScore,
                    classification
                ].join('\t');
                
                tsv += row + '\n';
            });

            // Menyalin ke clipboard menggunakan metode fallback (document.execCommand)
            let success = false;
            let tempElement = document.createElement('textarea');
            tempElement.value = tsv;
            tempElement.setAttribute('readonly', '');
            tempElement.style.position = 'absolute';
            tempElement.style.left = '-9999px';
            document.body.appendChild(tempElement);
            tempElement.select();
            
            try {
                // Gunakan document.execCommand('copy') karena navigator.clipboard diblokir
                success = document.execCommand('copy');
            } catch (err) {
                console.error('Gagal menyalin:', err);
                success = false;
            } finally {
                document.body.removeChild(tempElement);
            }

            if (success) {
                window.showMessage(`Berhasil menyalin ${profiles.length} baris data ${index} ke clipboard. Siap ditempel di Excel!`, 'success');
            } else {
                window.showMessage('Gagal menyalin data ke clipboard. Peramban (browser) Anda mungkin memblokir fungsi ini.', 'danger');
            }
        };
        

        // --- FUNGSI AKORDION (GLOBAL) ---
        window.toggleAccordion = function(contentId, iconId) {
            const content = document.getElementById(contentId);
            const icon = document.getElementById(iconId);
            if (content.style.maxHeight === '0px' || !content.style.maxHeight) {
                // Buka akordion
                content.style.maxHeight = content.scrollHeight + "px";
                icon.classList.add('rotate-180');
            } else {
                // Tutup akordion
                content.style.maxHeight = '0px';
                icon.classList.remove('rotate-180');
            }
        }
        // --- END FUNGSI AKORDION ---
        
        // --- FUNGSI INTERPOLASI CUBIC SPLINE (untuk 61-228m) ---
        // Fungsi untuk menghitung LMS pada usia/tinggi tertentu menggunakan data LMS yang disediakan
        function interpolateLMS(dataPoints, x) {
            let p1, p2;

            // Kasus 1: Nilai x berada di luar batas (ekstrapolasi)
            if (x < dataPoints[0][0]) {
                p1 = dataPoints[0];
                p2 = dataPoints[1];
            } else if (x > dataPoints[dataPoints.length - 1][0]) {
                p1 = dataPoints[dataPoints.length - 2];
                p2 = dataPoints[dataPoints.length - 1];
            } else {
                // Kasus 2: Nilai x berada di dalam batas (interpolasi linier)
                for (let i = 0; i < dataPoints.length - 1; i++) {
                    if (x >= dataPoints[i][0] && x <= dataPoints[i + 1][0]) {
                        p1 = dataPoints[i];
                        p2 = dataPoints[i + 1];
                        break;
                    }
                }
            }

            if (!p1 || !p2) {
                // Jika data point tidak ditemukan (seharusnya tidak terjadi jika batas sudah dicek)
                return { L: 0, M: 0, S: 0 }; 
            }

            const x1 = p1[0];
            const L1 = p1[1], M1 = p1[2], S1 = p1[3];
            const x2 = p2[0];
            const L2 = p2[1], M2 = p2[2], S2 = p2[3];

            if (x1 === x2) return { L: L1, M: M1, S: S1 };

            const ratio = (x - x1) / (x2 - x1);

            const L = L1 + (L2 - L1) * ratio;
            const M = M1 + (M2 - M1) * ratio;
            const S = S1 + (S2 - S1) * ratio;

            return { L, M, S };
        }

        // --- PENGGABUNGAN DATA LMS 0-228m ---
        
        let HFA_M_LMS_EXT = HFA_M_LMS_0_60;
        let HFA_F_LMS_EXT = HFA_F_LMS_0_60;
        let BFA_M_LMS_EXT = BFA_M_LMS_0_60;
        let BFA_F_LMS_EXT = BFA_F_LMS_0_60;

        // Tambahkan data 61-228m (WHO Reference) menggunakan interpolasi
        function generateExtendedLMS(data60, dataPoints) {
            let extendedData = [...data60];
            for (let m = 61; m <= MAX_AGE_MONTHS; m++) {
                const { L, M, S } = interpolateLMS(dataPoints, m);
                extendedData.push([m, L, M, S]);
            }
            return extendedData;
        }

        HFA_M_LMS_EXT = generateExtendedLMS(HFA_M_LMS_0_60, HFA_M_LMS_61_228_POINTS);
        HFA_F_LMS_EXT = generateExtendedLMS(HFA_F_LMS_0_60, HFA_F_LMS_61_228_POINTS);
        BFA_M_LMS_EXT = generateExtendedLMS(BFA_M_LMS_0_60, BFA_M_LMS_61_228_POINTS);
        BFA_F_LMS_EXT = generateExtendedLMS(BFA_F_LMS_0_60, BFA_F_LMS_61_228_POINTS);


        // --- UTILITY Z-SCORE DAN KLASIFIKASI ---

        /** Menghitung Z-score menggunakan metode LMS. */
        function calculateZScore(measurement, L, M, S) {
            if (L === 0) {
                // Rumus untuk L = 0 (Normal Distribution)
                return (Math.log(measurement / M)) / S;
            } else {
                // Rumus untuk L != 0 (Box-Cox Transformation)
                return (Math.pow(measurement / M, L) - 1) / (L * S);
            }
        }

        /** Mendapatkan klasifikasi status gizi berdasarkan Z-score. */
        function getClassification(zScore, index) {
            if (zScore === 'N/A' || typeof zScore !== 'number') return { classification: 'N/A', color: 'bg-gray-100' };

            let classification = 'Normal';
            let color = 'bg-success';

            if (index === 'WFA' || index === 'WFL' || index === 'BFA') { // BB/U, BB/TB, IMT/U
                if (zScore < -3) { classification = 'Sangat Kurang/Gizi Buruk'; color = 'bg-danger'; }
                else if (zScore < -2) { classification = 'Kurang/Gizi Kurang'; color = 'bg-warning'; }
                else if (zScore > 3) { classification = 'Obesitas'; color = 'bg-danger'; }
                else if (zScore > 2) { classification = 'Gizi Lebih/Gemuk'; color = 'bg-warning'; }
                else if (zScore > 1) { classification = 'Risiko Gizi Lebih'; color = 'bg-info'; }
            } else if (index === 'HFA') { // TB/U (Stunting)
                if (zScore < -3) { classification = 'Sangat Pendek (Severe Stunting)'; color = 'bg-danger'; }
                else if (zScore < -2) { classification = 'Pendek (Stunting)'; color = 'bg-warning'; }
                else if (zScore > 3) { classification = 'Tinggi'; color = 'bg-info'; }
            }
            return { classification, color };
        }
        
        /** Mengambil nilai L, M, S dari tabel LMS berdasarkan usia/tinggi. */
        function getLMS(index, sex, ageMonths, heightCm) {
            let data = [];
            let xValue; 
            let key;

            // 1. Tentukan set data yang akan digunakan
            if (index === 'WFA' || index === 'HFA' || index === 'BFA') {
                xValue = Math.floor(ageMonths);
                key = `${index}_${sex}_${xValue}`;
                if (sex === 'male') {
                    if (index === 'WFA') data = WFA_M_LMS;
                    else if (index === 'HFA') data = HFA_M_LMS_EXT;
                    else if (index === 'BFA') data = BFA_M_LMS_EXT;
                } else {
                    if (index === 'WFA') data = WFA_F_LMS;
                    else if (index === 'HFA') data = HFA_F_LMS_EXT;
                    else if (index === 'BFA') data = BFA_F_LMS_EXT;
                }
                
                // Cek batas usia
                if ((index === 'WFA' || index === 'WFL') && ageMonths > 60) {
                    return null; // BB/U dan BB/TB tidak berlaku > 60 bulan
                }
                if (ageMonths > MAX_AGE_MONTHS) {
                    return null; // Indeks berbasis usia tidak berlaku > 228 bulan
                }

            } else if (index === 'WFL') { // BB/TB
                xValue = Math.round(heightCm * 2) / 2; // Pembulatan ke 0.5cm terdekat
                key = `${index}_${sex}_${xValue}`;
                if (sex === 'male') data = WFL_M_LMS;
                else data = WFL_F_LMS;

                // Cek batas tinggi/panjang (WHO 0-5 tahun menggunakan batas 45-110cm)
                if (heightCm < 45 || heightCm > 110 || ageMonths > 60) {
                     return null; 
                }
            }

            // Cek cache (opsional, untuk optimasi)
            if (window.lmsDataCache[key]) {
                return window.lmsDataCache[key];
            }
            
            // 2. Cari data di tabel (Linear Interpolation)
            // Cari data di tabel (menggunakan floor untuk umur bulanan atau round untuk tinggi/panjang)
            const row = data.find(r => r[0] === xValue);

            if (row) {
                const result = { L: row[1], M: row[2], S: row[3] };
                window.lmsDataCache[key] = result;
                return result;
            }

            // Jika tidak ditemukan dalam tabel (misalnya, interpolasi untuk usia 61-228 sudah dilakukan di HFA_M_LMS_EXT, dst)
            // Untuk WFL (45-110), jika tidak ditemukan, berarti out of range
            return null;
        }

        // --- FUNGSI UTAMA KALKULASI ---

        /** Menghitung usia anak dari tanggal lahir ke tanggal hari ini. */
        function calculateAge(dobString) {
            const dob = new Date(dobString);
            const now = new Date();

            if (isNaN(dob.getTime())) {
                return null;
            }

            // Hitung selisih total hari
            const diffTime = Math.abs(now - dob);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            // Hitung Bulan dan Hari untuk display
            const years = now.getFullYear() - dob.getFullYear();
            const months = now.getMonth() - dob.getMonth() + (years * 12);

            let day = now.getDate() - dob.getDate();
            let preciseMonths = months;

            if (day < 0) {
                // Sesuaikan bulan dan hari (misalnya dari 10 Maret ke 10 April = 1 bulan, 0 hari)
                const lastMonth = new Date(now.getFullYear(), now.getMonth(), 0);
                day += lastMonth.getDate();
                preciseMonths -= 1;
            }

            // Hitung usia desimal (WHO-NCHS menggunakan usia desimal terdekat ke 0.01)
            const daysInMonth = (new Date(now.getFullYear(), now.getMonth() + 1, 0)).getDate();
            const decimalMonths = preciseMonths + (day / daysInMonth);
            
            // Menghitung bulan dan hari sisa yang ditampilkan
            const displayMonths = Math.floor(decimalMonths);
            const displayDays = Math.round((decimalMonths - displayMonths) * 30.4375); // Rata-rata hari per bulan

            return {
                totalMonths: parseFloat(decimalMonths.toFixed(2)),
                display: `${displayMonths} bulan ${displayDays} hari`
            };
        }

        /** Fungsi utama yang dipanggil saat ada perubahan input. */
        window.calculateNutritionStatus = function() {
            window.hideDeleteModal(); // Pastikan konfirmasi hapus dibatalkan
            window.hideValidationModal(); // Sembunyikan modal validasi jika ada
            
            const formData = window.getFormData();
            const dobString = formData.dob;
            const sex = formData.sex;
            const weight = formData.weight;
            const height = formData.height;
            
            const ageDisplayBox = document.getElementById('age-display');
            const resultsGrid = document.getElementById('results-grid');
            
            // Reset UI for calculation part
            resultsGrid.innerHTML = '';
            window.currentZScoreResults = {};
            
            let validForCalc = true;
            let displayWarning = false;

            // 1. Validasi Input Dasar
            // Ambil nilai dari DOM secara langsung untuk cek kekosongan
            const nameValue = document.getElementById('child-name').value.trim();
            const dobValue = document.getElementById('dob').value;
            const weightValue = document.getElementById('weight').value.trim();
            const heightValue = document.getElementById('height').value.trim();

            if (!nameValue) { validForCalc = false; displayWarning = true; }
            else if (dobValue === MASK || dobValue === MASK_DEFAULT || dobValue === '//' || !dobString) { 
                // KASUS 1: TTL Invalid atau Belum Lengkap/diisi
                if (dobValue.replace(/_/g, '').length === 10) {
                     window.showValidationModal('Tanggal Lahir Tidak Valid', 'Pastikan Tanggal Lahir diisi lengkap dengan format HH/BB/TTTT yang valid (misal: 01/01/2020). Cek kombinasi Hari, Bulan, dan Tahun.');
                } else if (dobValue !== MASK_DEFAULT) {
                    // Jika user sudah mulai mengetik tapi belum lengkap, jangan tampilkan modal, cukup pesan peringatan umum.
                    displayWarning = true;
                } else {
                     displayWarning = true;
                }
                validForCalc = false;
            }
            else if (weightValue === '' || isNaN(weight) || weight <= 0) { validForCalc = false; displayWarning = true; }
            else if (heightValue === '' || isNaN(height) || height <= 0) { validForCalc = false; displayWarning = true; }
            
            
            const ageResult = calculateAge(dobString);
            
            // Simpan status usia ke dalam elemen tersembunyi
            const ageDisplayStatus = ageResult ? ageResult.display : 'Format Tgl Salah / Belum Lengkap';
            if (ageDisplayBox) ageDisplayBox.textContent = ageDisplayStatus; // Simpan di background

            if (ageResult) {
                currentAgeMonths = ageResult.totalMonths;
            } else {
                currentAgeMonths = 0;
            }

            // 2. Cek Batas Usia
            if (!validForCalc) {
                 // Hanya tampilkan peringatan input jika data antropometri kosong (Non-TTL error)
                if (displayWarning) {
                    window.showMessage('PERINGATAN: Pastikan semua data antropometri (Nama, TTL, BB, TB/PB) sudah terisi dan valid.', 'danger');
                }
                window.updateVisualization();
                return;
            }
            
            if (currentAgeMonths > MAX_AGE_MONTHS) {
                 // KASUS 2: Usia di atas batas
                window.showValidationModal('Batas Usia Terlampaui', `Usia anak (${ageDisplayStatus}) melebihi batas maksimum WHO-LMS (19 tahun / ${MAX_AGE_MONTHS} bulan). Perhitungan Z-score dihentikan.`);
                window.currentZScoreResults = {};
                window.updateVisualization();
                return; 
            }

            // 3. Lanjutkan dengan Perhitungan Z-score (Hanya jika lolos semua validasi)

            // Array Indeks untuk dihitung
            const indexes = ['WFA', 'HFA', 'WFL', 'BFA'];
            const results = {};
            let allNA = true;

            indexes.forEach(index => {
                const lms = getLMS(index, sex, currentAgeMonths, height);
                let zScore = 'N/A';
                let rawLMS = { L: 'N/A', M: 'N/A', S: 'N/A' };

                if (lms) {
                    try {
                        let measurement = (index === 'BFA') ? (weight / (height / 100) ** 2) : (index === 'WFL' ? weight : (index === 'WFA' ? weight : height));
                        zScore = calculateZScore(measurement, lms.L, lms.M, lms.S);
                        rawLMS = lms;
                        allNA = false;
                    } catch (e) {
                        zScore = 'N/A';
                    }
                }
                
                const { classification, color } = getClassification(zScore, index);
                
                results[index] = {
                    index: index,
                    title: getIndexTitle(index),
                    zScore: zScore,
                    classification: classification,
                    color: color,
                    rawLMS: rawLMS
                };
            });

            window.currentZScoreResults = results;
            renderResults(results);
            window.updateVisualization(); // Update visualization after calculation

            // Reset pesan ke default jika perhitungan berhasil
            if (!allNA) {
                document.getElementById('message-box').innerHTML = 'Masukkan data antropometri anak (Nama, TTL, BB, TB/PB) untuk memulai perhitungan status gizi.';
                document.getElementById('message-box').className = 'p-3 text-sm text-green-800 bg-green-100 border-l-4 border-success rounded-lg';
            }
        }

        /** Mendapatkan judul indeks yang ramah pengguna. */
        function getIndexTitle(index) {
            switch (index) {
                case 'WFA': return 'Berat Badan per Usia (BB/U)';
                case 'HFA': return 'Tinggi/Panjang Badan per Usia (TB/U)';
                case 'WFL': return 'Berat Badan per Tinggi/Panjang Badan (BB/TB)';
                case 'BFA': return 'IMT per Usia (IMT/U)';
                default: return index;
            }
        }

        /** Merender kartu hasil status gizi. */
        function renderResults(results) {
            const resultsGrid = document.getElementById('results-grid');
            resultsGrid.innerHTML = '';
            
            for (const index in results) {
                const res = results[index];
                const zScoreDisplay = res.zScore === 'N/A' ? 'N/A' : res.zScore.toFixed(2);
                
                const card = document.createElement('div');
                const bgColor = res.color.replace('bg-', 'bg-');
                card.className = `card-result rounded-lg ${bgColor} text-secondary border border-gray-200`;
                
                // Menghapus bagian L, M, S dan garis pemisah
                card.innerHTML = `
                    <h4 class="font-bold text-center">${res.title}</h4>
                    <div class="mt-1 text-center">
                        <p class="text-lg font-extrabold text-secondary">${zScoreDisplay}</p>
                        <p class="text-xs font-semibold mt-1 p-1 rounded-md bg-white/70">${res.classification}</p>
                    </div>
                `;
                resultsGrid.appendChild(card);
            }
            
            // Setelah merender, pastikan akordion Ringkasan Klasifikasi menyesuaikan tingginya jika terbuka
            const accordionContent = document.getElementById('accordion-content-summary');
            if (accordionContent.style.maxHeight !== '0px') {
                accordionContent.style.maxHeight = accordionContent.scrollHeight + "px";
            }
        }

        // --- FUNGSI VISUALISASI CANVAS ---

        window.updateVisualization = function() {
            const canvas = document.getElementById('zscore-canvas');
            const ctx = canvas.getContext('2d');
            const index = document.getElementById('visualization-index').value;
            const results = window.currentZScoreResults[index];
            const sex = document.getElementById('sex').value;
            const zScoreLabel = document.getElementById('zscore-label');

            const width = canvas.width;
            const height = canvas.height;

            ctx.clearRect(0, 0, width, height);

            if (!results || results.zScore === 'N/A') {
                zScoreLabel.textContent = results ? `${results.title}: N/A` : `Pilih Indeks`;
                ctx.fillStyle = '#f3f4f6'; // Gray-100
                ctx.fillRect(0, 0, width, height);
                ctx.fillStyle = '#9ca3af'; // Gray-400
                ctx.font = '16px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('Data Z-score Tidak Tersedia', width / 2, height / 2);
                return;
            }

            const zScore = results.zScore;
            zScoreLabel.textContent = `${results.title}: Z-score ${zScore.toFixed(2)}`;

            // Konfigurasi Visualisasi
            const minZ = -4; // Z-score minimum yang ditampilkan
            const maxZ = 4;  // Z-score maksimum yang ditampilkan
            const zRange = maxZ - minZ;
            
            const padding = 30;
            const chartWidth = width - 2 * padding;
            const chartHeight = height - 2 * padding;

            // Fungsi mapping Z-score ke posisi Y
            const mapZToY = (z) => padding + chartHeight * (1 - (z - minZ) / zRange);

            // Warna Kurva WHO
            const curveColors = {
                '+3': '#ef4444', // Danger (Red)
                '+2': '#f59e0b', // Warning (Amber)
                '+1': '#3b82f6', // Info (Blue)
                '0': '#10b981', // Success (Green, Median)
                '-1': '#3b82f6', // Info (Blue)
                '-2': '#f59e0b', // Warning (Amber)
                '-3': '#ef4444'  // Danger (Red)
            };

            // 1. Gambar Background Area
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);

            // 2. Gambar Garis Z-score (Horizontal)
            const zLines = [3, 2, 1, 0, -1, -2, -3];
            ctx.textAlign = 'right';
            ctx.font = '10px Inter';

            zLines.forEach(z => {
                const y = mapZToY(z);
                const color = curveColors[z.toString()];

                // Garis
                ctx.beginPath();
                ctx.strokeStyle = color;
                ctx.lineWidth = (z === 0) ? 2 : 1;
                ctx.setLineDash((z === 0) ? [] : [4, 4]);
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();

                // Label
                ctx.fillStyle = color;
                ctx.fillText(`Z=${z}`, padding - 5, y + 4);
            });
            ctx.setLineDash([]); // Reset line dash

            // 3. Gambar Titik Data Anak
            const dataY = mapZToY(zScore);
            const dataX = width / 2; // Titik tengah

            // Lingkaran luar (border)
            ctx.beginPath();
            ctx.arc(dataX, dataY, 10, 0, Math.PI * 2, false);
            ctx.fillStyle = '#000000';
            ctx.fill();
            
            // Lingkaran dalam (data point)
            ctx.beginPath();
            ctx.arc(dataX, dataY, 8, 0, Math.PI * 2, false);
            ctx.fillStyle = results.color === 'bg-danger' ? '#ef4444' : (results.color === 'bg-warning' ? '#f59e0b' : '#10b981');
            ctx.fill();

            // Teks Z-score di samping titik
            ctx.fillStyle = '#000000';
            ctx.textAlign = 'left';
            ctx.font = '12px Inter';
            ctx.fillText(`Anak: ${zScore.toFixed(2)}`, dataX + 15, dataY + 4);

            // 4. Garis Vertikal (untuk estetika)
            ctx.beginPath();
            ctx.strokeStyle = '#d1d5db';
            ctx.lineWidth = 1;
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.moveTo(width - padding, padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            // 5. Label Sumbu Y
            ctx.save();
            ctx.translate(10, height / 2);
            ctx.rotate(-Math.PI / 2);
            ctx.textAlign = 'center';
            ctx.fillStyle = '#4b5563'; // Gray-600
            ctx.fillText('Z-score (Simpangan Baku)', 0, 0);
            ctx.restore();
        }

        // --- INITIALIZATION ---

        window.onload = function() {
            // Inisialisasi akordion agar tertutup saat pertama kali dimuat
            const accordionContentSummary = document.getElementById('accordion-content-summary');
            const accordionContentResults = document.getElementById('accordion-content-results');
            if (accordionContentSummary) {
                accordionContentSummary.style.maxHeight = '0px';
            }
            if (accordionContentResults) {
                accordionContentResults.style.maxHeight = '0px';
            }
            
            // Set default values
            document.getElementById('child-name').value = '';
            document.getElementById('dob').value = MASK_DEFAULT; 
            document.getElementById('sex').value = 'male';
            document.getElementById('weight').value = '';
            document.getElementById('height').value = '';

            // MEMPERBAIKI: Menggunakan window.calculateNutritionStatus() untuk akses global
            window.calculateNutritionStatus(); 
            window.updateVisualization(); 
            
            // Tambahkan event listener untuk resize canvas
            window.addEventListener('resize', window.updateVisualization);
        };
    </script>
</body>
</html>
